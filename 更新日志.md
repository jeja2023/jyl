# 更新日志 (ChangeLog)

## [1.4.0] - 2026-02-28

### 🌐 PWA 与移动端增强 (PWA & Mobile UX)
- **Service Worker 深度集成**：引入 `vite-plugin-pwa`，实现静态资源全量预缓存。二次启动近乎秒开，并支持基础功能的离线访问。
- **独立应用体验**：配置了完整的 Web Manifest，支持“添加到主屏幕”。在 iOS 与 Android 端均可开启“独立窗口”模式，消除浏览器地址栏，沉浸感媲美原生 App。
- **智能安装引导**：自动注入主题色与高清图标，激活移动浏览器原生安装提示。

### ⚙️ 架构与配置现代化 (Architecture & Config)
- **配置中心化 (Config Service)**：
    - **单点维护**：不再在前后端重复定义变量。所有公开业务配置（如联系邮箱、客服微信）统一在后端 `.env` 中管理。
    - **动态分发**：后端新增 `/api/common/config` 接口，前端启动时自动同步。实现“修改配置 -> 重启后端 -> 全站即时生效”，无需前端重新打包。
- **认证系统精简**：彻底剥离并清理了所有微信小程序相关的冗余代码、控制器及路由，回归轻量、高效。
- **校验模型统一**：废弃特定类型的验证码模型，全面转向通用的 `VerifyCode` 体系，代码复用率显著提升。

### 💬 联系与反馈体系 (Feedback System)
- **动态联系中心**：重构“关于”页面。联系方式现由后端配置驱动，支持“一键复制客服微信”与“官方邮箱”展示。
- **交互式反馈入口**：个人中心新增“联系客服”菜单。采用原生 `ActionSheet` 交互，将复制操作与反馈引导整合，提升沟通效率。
- **智能身份呈现**：优化个人信息展示逻辑。系统根据登录方式（用户名/邮箱/手机）自动解析最合适的脱敏标识进行呈现，消除“未知账号”的挫败感。

### ✨ 核心业务逻辑增强 (Core Business Logic)
- **极客级单位溯源系统**
    - 数据库底层扩展：`HealthRecord` 模型新增 `indicatorUnits` 字段，以 JSON 强格式持久化存储每一次化验当下的“原始单位”。
    - OCR 智能解析联动：识别算法增强，自动捕获化验单中各项数值尾随的度量衡（如 `pmol/L`、`mIU/L` 等），并与表单双向绑定。
    - 全平台动态还原展示：
        - 首页、趋势页、详情页全面升级动态单位渲染引擎。
        - 采用“蓝字加粗”作为视觉锚点，高亮标注由用户原单带入的真实单位，消除不同医院检验科单位基准差异带来的阅读困扰。

### 🎨 交互与用户体验提升 (UI/UX)
- **趋势监控页深度进化**
    - **医疗级参考带图表**：折线画布底层引入动态渲染算法，实时生成覆盖全生命周期的“淡绿色正常参考区”（Reference Range Band），结合新生成的纵坐标（Y轴）独立刻度表，跨期数据是否溢出一目了然。
    - **视线跟从联动**：底部化验条目列表化身“监控伴侣”，顶部点选特定追踪指标（如 FT3）时，底部列表中对应元素自动浮现出浅蓝色底漆（Highlight），全程护航用户的比对视线。
    - **“防越界空转”阻尼与多重容错**：优化了缩放（Zoom In/Out）按钮逻辑。首创自适应真实数据量的阈值吸附机制；针对某独立单项测算无记录的情况，会渲染防空提示区域；寻址最新的有效值时，也加入了“向后溯源”机制，避免首条记录空白。
- **登录合规体验重构**
    - 打破业界边缘化的免责敷衍交互，首创将《用户服务协议》与《隐私政策》强制勾选框**直接上移至核心转化按钮（立即登录）正上方**。配合极其严谨的边距收缩计算（从 `60rpx` 收拢到紧绷的 `40rpx`），实现了确保最高级别的法务合规透明度与用户操作一气呵成。

### 🚀 部署与运维 (Deployment & DevOps)
- **工程化容器支持 (Dockerization)**
    - 新增 **`docker/`** 专用目录，实现部署配置与核心源码的解耦，保持项目根目录整洁。
    - 引入 **多阶段构建 (Multi-stage Build)** 技术：镜像构建过程中自动执行前端 H5 编译并注入后端托管路径，实现“镜像即服务”，宿主机无需预装任何前端开发套件。
    - **MySQL 8.0 深度适配**：将数据库镜像升级至 MySQL 8.0，并预置 `mysql_native_password` 认证插件兼容性配置，确保与 Node.js 驱动完美对接。
    - **配置动态同步**：重构 `docker-compose.yml`，实现自动读取 `.env_docker` 环境变量，一套配置同时驱动应用与数据库容器，降低维护成本。
    - **部署安全性加固**：新增 `.env_docker.example` 模板文件，并在 `.gitignore` 中完善了对生产环境敏感配置的忽略规则。
    - **部署全链路自动化**：
        - **自动目录治理**：`docker-compose` 结合 `index.js` 实现宿主机 `storage` 目录及其子文件夹 `reports` 的**零人工干预创建**，通过 `recursive: true` 算法确保容器挂载瞬间即刻就绪。
        - **数据库自动迁移框架**：引入 `sequelize.sync({ alter: true })`，镜像启动后会自动探测并扩充数据库字段（如 `email` 字段自动补全），支持平滑升级。
        - **JWT 安全引擎**：全线引入 64 位十六进制高强度安全密钥，强化了用户 Token 的防伪能力。

### 📧 认证与注册系统重构 (Auth & Register)
    - **邮箱注册/混合登录系统全实装**：
        - 流程变更：由原有的手机注册改为更加通用的**邮箱验证码表单注册**。支持填写用户名、邮箱、验证码及确认密码。
        - **混合识别登录**：登录入口已升级，用户可自由选择输入“用户名”或“注册邮箱”配合密码进行秒级登录。
        - **不重名约束**：数据库底层增强 `username` 唯一性强制校验，保障品牌与用户身份的唯一性，防止马甲号。
        - **美观的邮件模板**：引入 `nodemailer` 并设计了极简蓝调的 HTML 验证码邮件模板，提升品牌第一印象。
    - **社交登录清理**：彻底停用并剥离了所有涉及微信一键登录的前后端逻辑分支，回归纯净、隐私友好的账号体系。
    - **合规文档同步**：重写了《用户协议》与《隐私政策》，将原有的手机/微信授权条款一键迁移至邮箱与用户名验证体系。

## [1.3.0] - 2026-02-05

### 🛡️ 安全加固 (Security Enhancement)
- **HTTP 安全头**
    - 引入 `koa-helmet` 中间件，自动设置 15 个安全相关的 HTTP 响应头（XSS 保护、禁止内嵌 Iframe 等）。
- **暴力破解防护**
    - 引入 `koa-ratelimit`，对登录、注册、短信验证码接口实施速率限制。
    - 登录/注册：每分钟最多 10 次尝试；短信验证码：每分钟最多 3 次请求。
- **XSS 内容清洗**
    - 引入 `xss` 库，对百科文章投稿内容进行深度清洗，过滤恶意脚本标签。
- **文件上传安全**
    - 增加 10MB 文件大小限制，防止大文件导致服务器内存溢出。
    - 增加文件后缀白名单 (jpg/png/webp)，防止上传恶意文件。
- **凭据安全**
    - 第三方登录（微信）不再使用硬编码默认密码，改为生成随机安全密码。

### ⚡ 性能优化 (Performance Optimization)
- **响应压缩**
    - 引入 `koa-compress`，对 JSON、JS、CSS 等文本响应进行 Gzip 压缩，减少约 70% 传输流量。
- **数据库索引**
    - 在 `HealthRecords` 表的 `UserId` 和 `recordDate` 字段上增加索引，显著提升查询速度。
- **并发查询优化**
    - 个人统计接口 (`/api/auth/stats`) 改用 `Promise.all` 并发查询，响应延迟降低约 50%。
- **异步 IO**
    - 图片上传改用 `fs.promises.writeFile`，避免阻塞 Node.js 事件循环。
- **Docker 镜像升级与配置优化**
    - 数据库镜像升级至 MySQL 8.0，并预置 `mysql_native_password` 认证插件兼容性配置。
    - 重构 `docker-compose.yml`，实现自动读取 `.env_docker` 环境变量，一套配置同时驱动应用与数据库容器。
    - 新增 `.env_docker.example` 模板文件，并在 `.gitignore` 中完善了对生产环境敏感配置的忽略规则。
    - `/storage` 目录静态文件设置 HTTP 强缓存（1 天），减少重复请求。

### 🔧 架构优化 (Architecture Improvement)
- **前端代码复用**
    - 新增 `client/src/utils/indicator.js` 工具类，统一指标判断逻辑。
    - `index.vue`、`list.vue`、`detail.vue` 导入公共工具，消除约 60 行重复代码。
- **前端请求优化**
    - 首页移除 `onMounted` 与 `onShow` 重复的数据请求。
    - 多个独立 API 请求使用 `Promise.all` 并行执行。
- **后端日志规范化**
    - 新增 `server/utils/logger.js` 统一日志工具，支持日志级别控制和格式化输出。
    - `DbService`、`UploadController`、`errorHandler` 等模块统一使用 logger。
- **环境变量校验**
    - 新增 `server/utils/envCheck.js`，服务启动时自动检查必要环境变量配置。
    - 缺失关键配置时给出明确提示并终止启动，避免运行时崩溃。
- **数据库服务解耦**
    - 新增 `server/services/DbService.js`，将数据库初始化、迁移、种子数据逻辑从 `index.js` 中抽离。

### 🐛 问题修复 (Bug Fixes)
- **趋势数据排序**
    - 修复趋势 API 返回最早 12 条记录的问题，改为正确返回最新 12 条记录。
- **路由配置**
    - 移除已废弃的 `/api/upload/report/:filename` 路由，避免引用不存在的方法导致启动失败。

## [1.2.0] - 2026-02-04

### ✨ 核心业务逻辑增强 (Core Business Logic)
- **个人统计系统实装**
    - 后端引入 `optionalAuth` 机制，支持在公开访问百科详情时同步记录登录用户的阅读量。
    - 修正“我的”页面“百科阅读”数据不真实的问题，实现阅读行为实时统计。
- **消息中心与自动化提醒**
    - 全新上线“消息中心”页面，整合系统公告与个人健康提醒。
    - 实现智能复查提醒逻辑：根据历史化验单时间点，自动预判并生成未来30天的复查日程提醒。
- **服药打卡看板**
    - 用药计划页改版，引入“服药打卡”按钮及今日状态标识，提升慢病管理依从性。
    - 后端记录 `lastTakenDate`，支持跨天状态重置。

### 🎨 登录系统与合规性重构 (Authentication & Compliance)
- **Premium 登录视觉方案**
    - 采用极简双选项卡（账号登录/手机注册）设计，配合品牌绿微信一键登录图标。
    - 增加登录页“弥散光影”动态背景，提升首屏高级感。
- **全平台预览支持**
    - 针对 H5 运行环境开发了“微信模拟登录”通道，跳过授权直接进入流程预览。
- **法务合规补齐**
    - 强制勾选《用户协议》与《隐私政策》后方可登录。
    - 新增独立协议页面：详细界定医疗免责范围、信息收集范围及账号注销权利。

### 🛠️ 性能与样式优化 (Stability & UI)
- **趋势图表升级**
    - 趋势页面图表支持动态缩放（Zoom），支持查看任意密度的数据点。
    - 新增“指标越位”视觉提示：数据值高于/低于参考值时，自动显示红色/橙色高亮及状态方向箭头。
- **首页动画修正**
    - 修复首页 Dashboard 引导图标旋转时圆周偏移的问题，改进 `transform` 动画层级。
- **数据库健壮性**
    - 后端启动时自动执行 SQL 碎片检查，自动注入缺失字段（如 `wikiReadCount`, `lastTakenDate`）。

## [1.1.0] - 2026-02-04

### ✨ 视觉与定位优化 (Design & Position)
- **定位明确与免责声明**
    - 明确应用定位为“甲状腺病友指标管理监测工具”，**非医疗器械**，不提供任何医疗诊断和建议。
    - **关于页面**：新增显著的“医疗免责声明”板块，重点提示医疗风险。
    - **首页提示**：在首页顶部新增常驻/滚动告警通知栏，强调非医疗用途。
    - **登录页优化**：底部及文案中加入免责提示，Logo Slogan 更新为“指标管理 · 趋势监测 · 经验交流”。
- **Logo 升级**
    - 重新设计项目 Logo，移除所有涉及“MEDICAL APP”的英文字样，采用纯图形化的蝴蝶（甲状腺抽象）与心形结合设计。
- **全站 UI/UX 深度重构**
    - **视觉规范**：统一全站圆角（40-50rpx）与品牌蓝（#3E7BFF）渐变系统。
    - **登录页**：采用弥散光影背景、玻璃拟态卡片，重塑微信登录品牌色。
    - **百科页**：优化分类导航平滑切换效果，文章卡片层级重构，详情页阅读排版升级。
    - **录入页**：新增指标录入进度条，网格化参数填写布局，OCR 识别反馈交互优化。
    - **用药页**：每日贴士升级为“沉浸式卡片”，时刻列表采用极简大文本设计，提升操作关怀感。

## [1.0.1] - 2026-02-01

### ✨ 新增功能 (Features)
- **后端**
    - 新增 `HealthTip` 数据库模型及 `HealthTipController`，支持健康贴士内容的动态管理。
    - 新增 `/api/tip/random` 接口，随机返回一条健康贴士，并具备种子数据自动初始化功能。
- **前端 (H5)**
    - 网络请求配置 (`request.js`) 增加智能判断逻辑：在 H5 环境下通过局域网访问时，自动将 `baseURL` 切换为当前 Host IP，无需手动修改代码即可实现手机连接电脑后端调试。
- **UI/UX**
    - **登录页**：界面改版，移除“QQ登录”，新增“手机登录”入口（预留接口），文案调整为“其他登录方式”。
    - **用药提醒**：每日贴士不再硬编码，改为从后端动态获取，增强内容可维护性。

### 🐛 问题修复 (Bug Fixes)
- **滚动体验优化**
    - **首页 (`index/index`)**：移除容器固定高度 `height: 100vh` 和 `overflow: hidden`，改为 `min-height`，解决内容溢出无法滚动的问题。
    - **趋势页 (`record/list`)**：重构布局，移除内层滚动容器，全面启用页面级原生滚动，提升移动端滑动流畅度。
    - **用药提醒页 (`medication/plan`)**：将 `scroll-view` 替换为普通 `view` 布局，解决在部分手机浏览器中列表高度塌陷、内容不显示的问题。
- **代码规范**
    - 修复 `index.vue` 和 `wiki/list.vue` 中 `line-clamp` 属性缺失标准写法导致的 IDE 语法警告。
    - 修复 `medication/plan.vue` 中因误删变量导致的 `plans is not defined` 运行时错误。
