# 甲友乐 JYL 项目部署指南

该指南将指导您如何将“甲友乐”项目从开发环境部署到生产服务器（Linux/Ubuntu/CentOS）。

## 1. 部署架构说明

*   **前端**：uni-app (Vue 3) 构建的 H5产物。
*   **后端**：Node.js (Koa 2) 服务，负责提供 API 接口并直接托管前端静态文件。
*   **数据库**：MySQL 5.7+。
*   **进程管理**：PM2 (确保后端服务挂掉后自动重启)。
*   **反向代理**：Nginx (负责 SSL 证书配置及请求转发)。

---

## 2. 准备工作

在服务器上安装以下必要软件：
- **Node.js**: v16 或更高版本。
- **MySQL**: 5.7+。
- **PM2**: `npm install -g pm2`。
- **Git**: 用于拉取代码。

---

## 3. 部署步骤

### 第一步：获取代码并安装依赖

```bash
# 克隆代码
git clone <your-repository-url>
cd jyl

# 安装后端依赖
cd server
npm install

# 安装前端依赖
cd ../client
npm install
```

### 第二步：配置环境并准备前端产物

1.  **前端构建**：
    在 `client` 目录下执行构建命令，生成 H5 静态资源：
    ```bash
    npm run build:h5
    ```
    构建产物将位于 `client/dist/build/h5`。

2.  **后端环境配置**：
    进入 `server` 目录，将 `.env.example` 复制为 `.env` 并根据实际情况修改：
    ```bash
    cp .env.example .env
    # 使用 vim 或 nano 编辑配置数据库连接、JWT 密钥、腾讯云 OCR 密钥等
    vim .env
    ```

3.  **数据库初始化**：
    确保服务器上已创建对应的数据库名，后端通过 `DbService.init()` 在启动时会自动同步表结构并初始化种子数据（百科条目、贴士等）。

### 第三步：使用 PM2 启动后端服务

在 `server` 目录下启动：
```bash
pm2 start index.js --name jyl-server
pm2 save
pm2 startup
```
*提示：后端会自动托管上一步生成的 `client/dist/build/h5` 中的静态文件，您无需单独配置 Nginx 托管前端。*

---

## 4. (可选) 配置 Nginx 与 SSL

通常建议在前端增加一层 Nginx 反向代理，以提供 HTTPS 支持：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /path/to/fullchain.pem;
    ssl_certificate_key /path/to/privkey.pem;

    location / {
        proxy_pass http://localhost:3000; # 转发到 Koa 后端
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

---

## 5. 存储与权限

确保后端进程对根目录下的 `storage` 文件夹有读写权限，以便能够保存 OCR 上传的化验单图片：
```bash
sudo chown -R $USER:$USER storage
chmod -R 755 storage
```

---

## 6. 常见问题排查

1.  **页面 404**：如果您直接在浏览器地址栏刷新 SPA 路由（如 `/pages/record/list`），后端已经配置了回退机制返回 `index.html`。
2.  **图片不显示**：检查 `server/.env` 中的环境变量，确保访问地址与后端端口或 Nginx 配置一致。
3.  **数据库连接错误**：请确保 MySQL 运行正常，且 `.env` 中的用户名、密码和端口填写正确。

---

## 7. 使用 Docker 一键部署 (推荐方案)

为了保持项目根目录整洁，所有 Docker 相关文件（Dockerfile, docker-compose.yml 等）均存放在专用的 **`docker/`** 目录下。

### 构建与启动

1.  **准备环境**：
    确保您的服务器已安装 **Docker** 和 **Docker Compose**。

2.  **配置变量**：
    编辑 **`docker/.env_docker`** 文件，根据服务器真实情况修改配置。
    *注：`DB_HOST` 应设为 `jyl-db`（即 docker-compose 中定义的数据库服务名）。*

3.  **运行命令**：
    直接在项目根目录下执行以下命令（通过 `-f` 指定路径）：
    ```bash
    docker-compose -f docker/docker-compose.yml up -d --build
    ```

### Docker 方案优势

- **根目录整洁**：所有容器化配置独立管理，不干扰主体代码库。
- **全镜像构建**：自动完成前端 H5 产物的编译工作，镜像内已预置构建产物。
- **环境隔离**：数据库、Node.js 运行时完全隔离，避免库版本冲突。
- **持久化挂载**：`storage` 目录和 `mysql_data` 卷已自动映射到父级目录，重启容器不丢失数据。
- **自动化反代**：后端自动托管 `/client/dist/build/h5` 中的前端编译产物。

